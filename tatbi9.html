<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>quran</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f1f1f">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
:root{
  --bg:#0f1f1f;--card:#1f3535;--text:#eaeaea;
  --accent:#d32f2f;--gold:#ffcc33;
}
.light{ --bg:#f2f2f2; --card:#fff; --text:#1f1f1f; }
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{
  margin:0; min-height:100vh; background:var(--bg); color:var(--text);
  font-family:system-ui, -apple-system, sans-serif;
  display:flex; align-items:center; justify-content:center;
  padding:env(safe-area-inset-top) 12px env(safe-area-inset-bottom);
  transition: background .3s, color .3s;
}
.app{
  width:100%; max-width:460px;
  background:var(--card); border-radius:20px;
  padding:18px; box-shadow:0 18px 40px rgba(0,0,0,.45);
  display:flex; flex-direction:column; gap:8px;
}
.header{display:flex;align-items:center;justify-content:space-between}
.icon{background:none;border:none;color:var(--text);font-size:1.4rem;cursor:pointer}
.title{text-align:center;font-weight:700}
.surah{font-size:1.9rem;color:var(--gold);text-align:center;margin:6px 0}
.reciter{text-align:center;opacity:.85;font-size:.9rem}

.row{display:flex;gap:8px;align-items:center}
input[type="search"], select{
  width:100%; padding:12px;border-radius:10px;border:none;font-size:1rem;outline:none;
  background:#fff;color:#000;
}

.controls{display:flex;justify-content:center;gap:18px;padding-top:6px}
.play{width:82px;height:82px;border-radius:50%;background:var(--accent);border:none;color:#fff;font-size:1.9rem;display:flex;align-items:center;justify-content:center;box-shadow:0 10px 20px rgba(211,47,47,.25)}
.play.playing{background:var(--gold);color:#000}
.small{font-size:1.3rem}
.progress{width:100%;height:10px;background:#ffffff22;border-radius:12px;cursor:pointer;overflow:hidden}
.bar{height:100%;width:0;background:var(--gold);border-radius:12px;transition:width .12s linear}
.time{display:flex;justify-content:space-between;font-size:.85rem;opacity:.95}
.range-wrap{display:flex;justify-content:center;align-items:center;padding-top:6px}
input[type="range"]{width:86%;accent-color:var(--gold)}

.bottom{display:flex;justify-content:space-around;padding-top:8px}
.repeat-active{color:var(--gold)!important}
.fav{color:#ff4757!important}

.status{text-align:center;font-size:.9rem;margin-top:6px;color:var(--accent);min-height:1.2em}

.select-mini{padding:8px;border-radius:10px;background:#fff;color:#000;border:none}

@media (max-width:420px){ .surah{font-size:1.6rem} .play{width:72px;height:72px} }
</style>
</head>
<body>
  <div class="app" role="main">
    <div class="header">
      <button id="theme" class="icon" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹"><i class="fas fa-moon"></i></button>
      <strong class="title">Ù…ØµØ­Ù ØªÙˆÙ†Ø³ (Ø¹Ù„ÙŠ Ø§Ù„Ø¨Ø±Ø§Ù‚)</strong>
      <button id="fav" class="icon" title="Ù…ÙØ¶Ù„Ø©"><i class="far fa-heart"></i></button>
    </div>

    <div class="surah" id="title">Ø§Ù„ÙØ§ØªØ­Ø©</div>
    <div class="reciter">Ø¨Ø±ÙˆØ§ÙŠØ© Ù‚Ø§Ù„ÙˆÙ† Ø¹Ù† Ù†Ø§ÙØ¹ â€” Ù†Ø³Ø®Ø© Ø£Ø±Ø´ÙŠÙ</div>

    <div class="row">
      <input id="search" type="search" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø§Ù„Ø³ÙˆØ±Ø©..." aria-label="Ø¨Ø­Ø« Ø³ÙˆØ±Ø©">
    </div>

    <select id="list" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙˆØ±" size="6" style="height:220px;padding:8px;border-radius:10px;background:#fff;color:#000"></select>

    <div class="controls">
      <button id="prev" class="icon small" title="Ø§Ù„Ø³Ø§Ø¨Ù‚"><i class="fas fa-backward-step"></i></button>
      <button id="play" class="play" title="ØªØ´ØºÙŠÙ„"><i class="fas fa-play"></i></button>
      <button id="next" class="icon small" title="Ø§Ù„ØªØ§Ù„ÙŠ"><i class="fas fa-forward-step"></i></button>
    </div>

    <div id="progress-container" class="progress" aria-label="Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù‘Ù…"><div id="bar" class="bar"></div></div>
    <div class="time"><span id="current">00:00</span><span id="duration">00:00</span></div>

    <div class="range-wrap">
      ğŸ”‰ <input id="volume" type="range" min="0" max="1" step="0.01" value="1"> ğŸ”Š
    </div>

    <div class="bottom">
      <button id="repeat" class="icon" title="ØªÙƒØ±Ø§Ø±"><i class="fas fa-redo"></i></button>
      <div style="display:flex;gap:6px">
        <button id="download" class="icon" title="ØªØ­Ù…ÙŠÙ„"><i class="fas fa-download"></i></button>
        <button id="showFavs" class="icon" title="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø§Øª"><i class="fas fa-list"></i></button>
      </div>
    </div>

    <select id="favList" style="display:none;margin-top:10px;padding:8px;border-radius:10px;background:#fff;color:#000"></select>

    <div style="display:flex;gap:8px;justify-content:center;margin-top:8px">
      <input id="sleepMinutes" class="select-mini" type="number" placeholder="Ø¯Ù‚Ø§Ø¦Ù‚ Ù†ÙˆÙ…" min="1" style="width:110px"/>
      <button id="setSleep" class="select-mini">ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø¤Ù‚Øª</button>
      <button id="clearSleep" class="select-mini">Ø¥Ù„ØºØ§Ø¡</button>
    </div>

    <div class="status" id="status" aria-live="polite"></div>
  </div>

  <audio id="audio" playsinline></audio>

<script>
/* â€”â€”â€”â€”â€” Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª â€”â€”â€”â€”â€” */
const surahs = [
"Ø§Ù„ÙØ§ØªØ­Ø©","Ø§Ù„Ø¨Ù‚Ø±Ø©","Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†","Ø§Ù„Ù†Ø³Ø§Ø¡","Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©","Ø§Ù„Ø£Ù†Ø¹Ø§Ù…","Ø§Ù„Ø£Ø¹Ø±Ø§Ù","Ø§Ù„Ø£Ù†ÙØ§Ù„","Ø§Ù„ØªÙˆØ¨Ø©","ÙŠÙˆÙ†Ø³",
"Ù‡ÙˆØ¯","ÙŠÙˆØ³Ù","Ø§Ù„Ø±Ø¹Ø¯","Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…","Ø§Ù„Ø­Ø¬Ø±","Ø§Ù„Ù†Ø­Ù„","Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡","Ø§Ù„ÙƒÙ‡Ù","Ù…Ø±ÙŠÙ…","Ø·Ù‡",
"Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡","Ø§Ù„Ø­Ø¬","Ø§Ù„Ù…Ø¤Ù…Ù†ÙˆÙ†","Ø§Ù„Ù†ÙˆØ±","Ø§Ù„ÙØ±Ù‚Ø§Ù†","Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡","Ø§Ù„Ù†Ù…Ù„","Ø§Ù„Ù‚ØµØµ","Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª","Ø§Ù„Ø±ÙˆÙ…",
"Ù„Ù‚Ù…Ø§Ù†","Ø§Ù„Ø³Ø¬Ø¯Ø©","Ø§Ù„Ø£Ø­Ø²Ø§Ø¨","Ø³Ø¨Ø£","ÙØ§Ø·Ø±","ÙŠØ³","Ø§Ù„ØµØ§ÙØ§Øª","Øµ","Ø§Ù„Ø²Ù…Ø±","ØºØ§ÙØ±",
"ÙØµÙ„Øª","Ø§Ù„Ø´ÙˆØ±Ù‰","Ø§Ù„Ø²Ø®Ø±Ù","Ø§Ù„Ø¯Ø®Ø§Ù†","Ø§Ù„Ø¬Ø§Ø«ÙŠØ©","Ø§Ù„Ø£Ø­Ù‚Ø§Ù","Ù…Ø­Ù…Ø¯","Ø§Ù„ÙØªØ­","Ø§Ù„Ø­Ø¬Ø±Ø§Øª","Ù‚",
"Ø§Ù„Ø°Ø§Ø±ÙŠØ§Øª","Ø§Ù„Ø·ÙˆØ±","Ø§Ù„Ù†Ø¬Ù…","Ø§Ù„Ù‚Ù…Ø±","Ø§Ù„Ø±Ø­Ù…Ù†","Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©","Ø§Ù„Ø­Ø¯ÙŠØ¯","Ø§Ù„Ù…Ø¬Ø§Ø¯Ù„Ø©","Ø§Ù„Ø­Ø´Ø±","Ø§Ù„Ù…Ù…ØªØ­Ù†Ø©",
"Ø§Ù„ØµÙ","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ù…Ù†Ø§ÙÙ‚ÙˆÙ†","Ø§Ù„ØªØºØ§Ø¨Ù†","Ø§Ù„Ø·Ù„Ø§Ù‚","Ø§Ù„ØªØ­Ø±ÙŠÙ…","Ø§Ù„Ù…Ù„Ùƒ","Ø§Ù„Ù‚Ù„Ù…","Ø§Ù„Ø­Ø§Ù‚Ø©","Ø§Ù„Ù…Ø¹Ø§Ø±Ø¬",
"Ù†ÙˆØ­","Ø§Ù„Ø¬Ù†","Ø§Ù„Ù…Ø²Ù…Ù„","Ø§Ù„Ù…Ø¯Ø«Ø±","Ø§Ù„Ù‚ÙŠØ§Ù…Ø©","Ø§Ù„Ø¥Ù†Ø³Ø§Ù†","Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª","Ø§Ù„Ù†Ø¨Ø£","Ø§Ù„Ù†Ø§Ø²Ø¹Ø§Øª","Ø¹Ø¨Ø³",
"Ø§Ù„ØªÙƒÙˆÙŠØ±","Ø§Ù„Ø§Ù†ÙØ·Ø§Ø±","Ø§Ù„Ù…Ø·ÙÙÙŠÙ†","Ø§Ù„Ø§Ù†Ø´Ù‚Ø§Ù‚","Ø§Ù„Ø¨Ø±ÙˆØ¬","Ø§Ù„Ø·Ø§Ø±Ù‚","Ø§Ù„Ø£Ø¹Ù„Ù‰","Ø§Ù„ØºØ§Ø´ÙŠØ©","Ø§Ù„ÙØ¬Ø±","Ø§Ù„Ø¨Ù„Ø¯",
"Ø§Ù„Ø´Ù…Ø³","Ø§Ù„Ù„ÙŠÙ„","Ø§Ù„Ø¶Ø­Ù‰","Ø§Ù„Ø´Ø±Ø­","Ø§Ù„ØªÙŠÙ†","Ø§Ù„Ø¹Ù„Ù‚","Ø§Ù„Ù‚Ø¯Ø±","Ø§Ù„Ø¨ÙŠÙ†Ø©","Ø§Ù„Ø²Ù„Ø²Ù„Ø©","Ø§Ù„Ø¹Ø§Ø¯ÙŠØ§Øª",
"Ø§Ù„Ù‚Ø§Ø±Ø¹Ø©","Ø§Ù„ØªÙƒØ§Ø«Ø±","Ø§Ù„Ø¹ØµØ±","Ø§Ù„Ù‡Ù…Ø²Ø©","Ø§Ù„ÙÙŠÙ„","Ù‚Ø±ÙŠØ´","Ø§Ù„Ù…Ø§Ø¹ÙˆÙ†","Ø§Ù„ÙƒÙˆØ«Ø±","Ø§Ù„ÙƒØ§ÙØ±ÙˆÙ†","Ø§Ù„Ù†ØµØ±",
"Ø§Ù„Ù…Ø³Ø¯","Ø§Ù„Ø¥Ø®Ù„Ø§Øµ","Ø§Ù„ÙÙ„Ù‚","Ø§Ù„Ù†Ø§Ø³"
];

const $ = id => document.getElementById(id);
const audio = $("audio");
const list = $("list"), titleEl = $("title"), playBtn = $("play"), bar = $("bar");
const current = $("current"), duration = $("duration"), status = $("status");
const favList = $("favList");

let favorites = JSON.parse(localStorage.getItem("favs") || "[]");
let repeat = false;
let sleepTimer = null;

/* â€”â€”â€”â€”â€” ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Ø¨Ù€ DOM Ø¨ÙƒÙØ§Ø¡Ø©) â€”â€”â€”â€”â€” */
function fillList(arr = surahs) {
  list.innerHTML = "";
  const frag = document.createDocumentFragment();
  arr.forEach((s,i) => {
    const o = document.createElement("option");
    o.value = i+1;
    o.textContent = `${i+1}. ${s}`;
    frag.appendChild(o);
  });
  list.appendChild(frag);
}
fillList();

/* â€”â€”â€”â€”â€” Ø¨Ù†Ø§Ø¡ Ø±Ø§Ø¨Ø· OGG Ù…Ù† Internet Archive â€”â€”â€”â€”â€”
  Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù‚Ø§Ù„Ø¨:
  https://archive.org/download/AlMos7afAl_mourattel_3liAlBarra9/001.ogg
*/
function fileUrl(id){
  const file = String(id).padStart(3,"0") + ".ogg";
  return `https://archive.org/download/AlMos7afAl_mourattel_3liAlBarra9/${file}`;
}

/* â€”â€”â€”â€”â€” ØªØ­Ù…ÙŠÙ„ ÙˆØªØ´ØºÙŠÙ„ Ù…Ø¹ ØªØ¹Ø§Ù…Ù„ Ø£ÙØ¶Ù„ Ù…Ø¹ Ø§Ù„Ø­Ø¸Ø± â€”â€”â€”â€”â€” */
async function load(id, auto=true){
  // Ø¶Ù…Ø§Ù† Ø£Ù† id Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¬Ø§Ù„
  id = Number(id) || 1;
  if(id < 1) id = 1; if(id > surahs.length) id = surahs.length;

  audio.pause();
  titleEl.textContent = surahs[id-1];
  status.textContent = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±...";

  const src = fileUrl(id);
  audio.src = src;
  audio.crossOrigin = "anonymous";
  audio.load();

  // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´ØºÙŠÙ„ Ø¨Ø¹Ø¯ ØªÙ‡ÙŠØ¦Ø© canplaythrough Ø£Ùˆ Ø¨Ø¹Ø¯ Ø®Ø·Ø£
  const playAttempt = async () => {
    try{
      if(auto){
        await audio.play();
        status.textContent = "â–¶ï¸ ØªØ´ØºÙŠÙ„";
      } else {
        status.textContent = "â¸ï¸ Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ´ØºÙŠÙ„";
      }
    }catch(err){
      // Ø¥Ø°Ø§ Ø­ÙØ¸ÙØ± Ø§Ù„ØªØ´ØºÙŠÙ„ â€” Ù†Ø·Ù„Ø¨ ØªÙØ§Ø¹Ù„ Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø¨Ø± Ø±Ø³Ø§Ù„Ø©
      console.warn("Playback blocked:", err);
      status.textContent = "ğŸ”‡ Ø§Ø¶ØºØ· Ø²Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ Ù„Ù„Ø¨Ø¯Ø¡";
    }
  };

  // oncanplaythrough ÙŠØ¹Ø·ÙŠ Ø«Ù‚Ø© Ø£Ù†Ù‘ Ø§Ù„Ù…ÙŠØ¯ÙŠØ§ Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ´ØºÙŠÙ„
  audio.oncanplaythrough = () => { playAttempt(); };
  audio.onerror = () => { status.textContent = "âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙˆØ±Ø© (Ø±Ø¨Ù…Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± Ù…ØªØ§Ø­)"; };
  updateFav(); updateFavList(); updateMediaSession();
}

/* â€”â€”â€”â€”â€” ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª â€”â€”â€”â€”â€” */
function fmt(t){
  if(!t || isNaN(t)) return "00:00";
  const m = Math.floor(t/60), s = Math.floor(t%60);
  return `${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
}

/* â€”â€”â€”â€”â€” Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØµÙˆØª â€”â€”â€”â€”â€” */
audio.ontimeupdate = () => {
  current.textContent = fmt(audio.currentTime);
  duration.textContent = fmt(audio.duration);
  bar.style.width = (audio.currentTime/audio.duration*100 || 0) + "%";
};
audio.onplay = () => { playBtn.classList.add("playing"); playBtn.innerHTML = '<i class="fas fa-pause"></i>'; status.textContent = "â–¶ï¸ ØªØ´ØºÙŠÙ„"; };
audio.onpause = () => { playBtn.classList.remove("playing"); playBtn.innerHTML = '<i class="fas fa-play"></i>'; status.textContent = "â¸ï¸ Ø¥ÙŠÙ‚Ø§Ù"; };
audio.onended = () => repeat ? audio.play() : next();
audio.onerror = () => status.textContent = "âš ï¸ ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù„Ù";

/* â€”â€”â€”â€”â€” ØªØ­ÙƒÙ…Ø§Øª â€”â€”â€”â€”â€” */
function togglePlay(){ audio.paused ? audio.play() : audio.pause(); }
function next(){
  if(list.selectedIndex < list.length - 1){ list.selectedIndex++; load(list.value); }
}
function prev(){
  if(list.selectedIndex > 0){ list.selectedIndex--; load(list.value); }
}

/* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù‘Ù… ØªÙØ§Ø¹Ù„ÙŠ */
$("progress-container").addEventListener("click", (e) => {
  const rect = e.currentTarget.getBoundingClientRect();
  const clickX = e.clientX - rect.left;
  audio.currentTime = (clickX / rect.width) * audio.duration;
});

/* Ø§Ù„Ù…ÙØ¶Ù„Ø© */
function updateFav(){
  $("fav").innerHTML = favorites.includes(list.value) ? '<i class="fas fa-heart fav"></i>' : '<i class="far fa-heart"></i>';
}
$("fav").addEventListener("click", () => {
  const v = list.value;
  favorites = favorites.includes(v) ? favorites.filter(f => f !== v) : [...favorites, v];
  localStorage.setItem("favs", JSON.stringify(favorites));
  updateFav(); updateFavList();
});
function updateFavList(){
  favList.innerHTML = "";
  if(!favorites.length){
    const o = document.createElement("option"); o.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙØ¶Ù„Ø§Øª"; favList.appendChild(o); return;
  }
  favorites.forEach(id=>{
    const o = document.createElement("option"); o.value = id; o.textContent = `${id}. ${surahs[id-1]}`; favList.appendChild(o);
  });
}
$("showFavs").onclick = () => {
  favList.style.display = favList.style.display === "none" ? "block" : "none";
  updateFavList();
};
favList.onchange = () => { list.value = favList.value; load(favList.value); };

/* ØªÙƒØ±Ø§Ø± */
$("repeat").onclick = () => { repeat = !repeat; $("repeat").classList.toggle("repeat-active", repeat); };

/* Ø§Ù„Ø¨Ø­Ø« (Ù„Ø§ Ù†Ø¹ÙŠØ¯ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£ØµÙˆÙ„) */
$("search").addEventListener("input", (e) => {
  const q = e.target.value.trim();
  if(!q) { fillList(); return; }
  const filtered = surahs.map((s,i)=>({s,i})).filter(x => x.s.includes(q)).map(x=>x.s);
  fillList(surahs.filter(s => s.includes(q)));
});

/* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
playBtn.onclick = () => {
  // playBtn Ù‚Ø¯ ØªÙÙ…Ù†Ø¹ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ src ØµØ§Ù„Ø­: Ù†Ø¶Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø®ÙŠØ§Ø± Ù…Ø­Ø¯Ø¯
  if(!list.value) { status.textContent = "Ø§Ø®ØªØ± Ø³ÙˆØ±Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©"; return; }
  // Ø¥Ù† ÙƒØ§Ù† audio.src ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù€ list.valueØŒ Ù†Ø­Ù…Ù‘Ù„Ù‡ Ø£ÙˆÙ„Ù‹Ø§ (Ù‡Ø°Ø§ ÙŠØ¬Ø¹Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„ ÙˆØ§Ø¶Ø­ Ù„Ù„Ù…ØªØµÙØ­)
  const currentIdx = Number(list.value);
  const src = audio.src;
  const shouldLoad = !src || !src.includes(String(currentIdx).padStart(3,"0"));
  if(shouldLoad){ load(currentIdx, true); } else { togglePlay(); }
};

$("next").onclick = next;
$("prev").onclick = prev;
list.onchange = () => load(list.value);

/* Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙˆØª */
$("volume").addEventListener("input", e => { audio.volume = e.target.value; localStorage.setItem("vol", e.target.value); });
const savedVol = localStorage.getItem("vol");
if(savedVol) { $("volume").value = savedVol; audio.volume = savedVol; }

/* ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙˆØ±Ø© */
$("download").onclick = () => {
  const id = list.value || 1;
  const url = fileUrl(id);
  // Ù†ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø© â€” Ø§Ù„Ù…ØªØµÙØ­ Ø³ÙŠØ¹Ø§Ù„Ø¬ Ø§Ù„ØªØ­Ù…ÙŠÙ„
  window.open(url, "_blank");
};

/* Ø«ÙŠÙ… ÙˆØ­ÙØ¸Ù‡ */
$("theme").onclick = () => {
  document.body.classList.toggle("light");
  localStorage.setItem("theme", document.body.classList.contains("light"));
};
if(localStorage.getItem("theme") === "true") document.body.classList.add("light");

/* Media Session API */
function updateMediaSession(){
  if(!("mediaSession" in navigator)) return;
  navigator.mediaSession.metadata = new MediaMetadata({
    title: titleEl.textContent,
    artist: "Ø§Ù„Ø´ÙŠØ® Ø¹Ù„ÙŠ Ø§Ù„Ø¨Ø±Ø§Ù‚",
    album: "Ù…ØµØ­Ù ØªÙˆÙ†Ø³ (Internet Archive)"
  });
  navigator.mediaSession.setActionHandler('play', ()=>audio.play());
  navigator.mediaSession.setActionHandler('pause', ()=>audio.pause());
  navigator.mediaSession.setActionHandler('previoustrack', prev);
  navigator.mediaSession.setActionHandler('nexttrack', next);
}

/* Ø§Ø³ØªØ¯Ø¹Ø§Ø¡Ø§Øª Ù…Ø¨ÙƒØ±Ø© */
load(1,false); // Ù„Ø§ ØªØ´ØºÙ‘Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ØŒ ÙÙ‚Ø· Ø¬Ù‡Ù‘Ø² Ø§Ù„Ø³ÙˆØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
updateFav(); updateFavList(); updateMediaSession();

/* ØªØ­Ø¯ÙŠØ« metadata Ø¹Ù†Ø¯ ÙƒÙ„ ØªØ­Ù…ÙŠÙ„ */
function updateMedia(){ updateMediaSession(); }

/* â€”â€”â€”â€”â€” Ù…Ø¤Ù‚Øª Ø§Ù„Ù†ÙˆÙ… (Sleep Timer) â€”â€”â€”â€”â€” */
$("setSleep").onclick = () => {
  const mins = Number($("sleepMinutes").value);
  if(!mins || mins <= 0){ status.textContent = "Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø¯Ù‚Ø§Ø¦Ù‚ ØµØ§Ù„Ø­"; return; }
  if(sleepTimer) clearTimeout(sleepTimer);
  sleepTimer = setTimeout(()=>{ audio.pause(); status.textContent = `â±ï¸ Ù…Ø¤Ù‚Øª (${mins} Ø¯Ù‚ÙŠÙ‚Ø©) Ø§Ù†ØªÙ‡Ù‰ â€” ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù`; sleepTimer = null; }, mins*60000);
  status.textContent = `â±ï¸ Ù…Ø¤Ù‚Øª Ø§Ù„Ù†ÙˆÙ… Ù…ÙØ¹Ù„ (${mins} Ø¯Ù‚ÙŠÙ‚Ø©)`;
};
$("clearSleep").onclick = () => {
  if(sleepTimer){ clearTimeout(sleepTimer); sleepTimer = null; status.textContent = "â±ï¸ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª Ø§Ù„Ù†ÙˆÙ…"; }
  else status.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¤Ù‚Øª Ù…ÙØ¹Ù„";
};

/* ØªØ­Ø³ÙŠÙ†: Ù„Ùˆ ÙØªØ­ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ù†ØµØ± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© â€” Ù†Ø­Ù…Ù‘Ù„ Ù…Ù„ÙÙ‡ */
list.addEventListener("click", (e) => {
  const val = list.value || 1;
  const wanted = String(val).padStart(3,"0");
  if(!audio.src.includes(wanted)) load(val,false);
});

/* Ø¹Ù†Ø¯Ù…Ø§ ÙŠØªØºÙŠØ± Ø§Ù„Ù…ØµØ¯Ø± Ø£Ùˆ Ø§Ù„Ø¹Ù†ØµØ± â€” Ø­Ø¯Ù‘Ø« Ø§Ù„Ù…ÙŠØªØ§Ø¯Ø§ØªØ§ */
audio.addEventListener("loadedmetadata", updateMedia);

</script>

<!-- ØªØ³Ø¬ÙŠÙ„ Service Worker (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„ØªØ­ÙˆÙŠÙ„ PWA Ù„Ø§Ø­Ù‚Ø§Ù‹) -->
<script>
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').catch(()=>{ /* Ù„Ø§ ØªÙØ´Ù„ */ });
}
/* â€”â€”â€”â€”â€” Ø­ÙØ¸ Ø§Ù„Ø³ÙˆØ±Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª â€”â€”â€”â€”â€” */
$("download").insertAdjacentHTML("afterend", `
  <button id="saveOffline" class="icon" title="Ø­ÙØ¸ Ù„Ù„ØªØ´ØºÙŠÙ„ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª"><i class="fas fa-cloud-download-alt"></i></button>
`);

const CACHE_NAME = "quran-offline-surahs";

$("saveOffline").onclick = async () => {
  const id = list.value || 1;
  const url = fileUrl(id);
  const name = `${id}.ogg`;

  status.textContent = `â¬‡ï¸ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ${surahs[id-1]}...`;

  try {
    const res = await fetch(url, {mode: "cors"});
    if (!res.ok) throw new Error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„");
    const cache = await caches.open(CACHE_NAME);
    await cache.put(url, res.clone());
    status.textContent = `âœ… ØªÙ… Ø­ÙØ¸ Ø³ÙˆØ±Ø© ${surahs[id-1]} Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª`;
  } catch (err) {
    console.error(err);
    status.textContent = "âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø­ÙØ¸ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª";
  }
};

/* Ø¹Ù†Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„ Ù†Ø­Ø§ÙˆÙ„ Ø£ÙˆÙ„Ù‹Ø§ ØªØ´ØºÙŠÙ„ Ù…Ù† Ø§Ù„ÙƒØ§Ø´ Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯ */
async function load(id, auto=true){
  id = Number(id) || 1;
  audio.pause();
  titleEl.textContent = surahs[id-1];
  status.textContent = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±...";

  const url = fileUrl(id);
  const cache = await caches.open(CACHE_NAME);
  const cached = await cache.match(url);

  if (cached) {
    audio.src = URL.createObjectURL(await cached.blob());
    status.textContent = "ğŸ“¦ ØªØ´ØºÙŠÙ„ Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©";
  } else {
    audio.src = url;
  }

  audio.load();

  const playAttempt = async () => {
    try {
      if (auto) {
        await audio.play();
        status.textContent = "â–¶ï¸ ØªØ´ØºÙŠÙ„";
      } else status.textContent = "â¸ï¸ Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ´ØºÙŠÙ„";
    } catch (err) {
      console.warn("Playback blocked:", err);
      status.textContent = "ğŸ”‡ Ø§Ø¶ØºØ· Ø²Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ Ù„Ù„Ø¨Ø¯Ø¡";
    }
  };
  audio.oncanplaythrough = () => playAttempt();
  audio.onerror = () => { status.textContent = "âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙˆØ±Ø©"; };
  updateFav(); updateFavList(); updateMediaSession();
}

</script>
</body>
</html>
